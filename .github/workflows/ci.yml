name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install basic system dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gcc g++ gfortran m4 patch git wget cmake libhdf5-dev \
          libopenblas-dev liblapack-dev flex bison autoconf automake autotools-dev
                
      - name: Get FreeFEM develop commit SHA
        id: get_freefem_commit
        run: |
          set -euo pipefail
          echo "Querying remote commit for FreeFem/FreeFem-sources develop..."
          sha=$(git ls-remote https://github.com/FreeFem/FreeFem-sources develop | awk '{print $1}')
          if [ -z "$sha" ]; then
            echo "Failed to fetch SHA for FreeFem-sources develop"
            exit 1
          fi
          echo "FreeFEM develop sha: $sha"
          echo "freefem_sha=$sha" >> $GITHUB_OUTPUT

      - name: Restore FreeFEM cache (by commit)
        uses: actions/cache@v4
        with:
          path: FreeFem-sources
          key: ${{ runner.os }}-freefem-${{ steps.get_freefem_commit.outputs.freefem_sha }}
          restore-keys: |
            ${{ runner.os }}-freefem-

      - name: Build FreeFEM (if needed)
        id: freefem
        env:
          FREEFEM_SHA: ${{ steps.get_freefem_commit.outputs.freefem_sha }}
        run: |
          set -euo pipefail
          echo "Expected FreeFEM sha: $FREEFEM_SHA"

          # If cache restored and .built_sha matches expected SHA and binary present, skip build.
          if [ -d "FreeFem-sources" ] && [ -f "FreeFem-sources/.built_sha" ] && grep -Fxq "$FREEFEM_SHA" FreeFem-sources/.built_sha && [ -x "FreeFem-sources/src/mpi/FreeFem++-mpi" ]; then
            echo "FreeFEM cache is present and matches expected commit — skipping build."
            ls -la FreeFem-sources/src/mpi || true
            exit 0
          fi

          # If directory exists, update it instead of recloning
          if [ -d "FreeFem-sources" ]; then
            echo "FreeFem-sources exists — updating in place."
            cd FreeFem-sources
            git pull
            echo "On commit: $(git rev-parse HEAD)"
          else
            # Clone fresh at develop (shallow) and ensure we're on the expected commit
            echo "Cloning FreeFem-sources (shallow) ..."
            git clone --branch develop --single-branch --depth 1 https://github.com/FreeFem/FreeFem-sources
            cd FreeFem-sources
            echo "On commit: $(git rev-parse HEAD)"
          fi

          # Now build
          autoreconf -i
          ./configure --enable-download --enable-optim --prefix="${PWD}"
          ./3rdparty/getall -a
          cd 3rdparty/ff-petsc
          make petsc-slepc
          cd -

          ./reconfigure
          make -j 4

          # write marker so future runs can validate the cache quickly
          echo "$FREEFEM_SHA" > .built_sha
          cd ..

      - name: Export FreeFEM env (PATH + load paths)
        run: |
          set -euo pipefail
          test -x "${{ github.workspace }}/FreeFem-sources/src/mpi/FreeFem++-mpi"
          test -x "${{ github.workspace }}/FreeFem-sources/src/nw/ff-mpirun"

          echo "${{ github.workspace }}/FreeFem-sources/src/mpi" >> $GITHUB_PATH
          echo "${{ github.workspace }}/FreeFem-sources/src/nw" >> $GITHUB_PATH

          echo "FF_INCLUDEPATH=${{ github.workspace }}/FreeFem-sources/idp" >> $GITHUB_ENV
          echo "FF_LOADPATH=${{ github.workspace }}/FreeFem-sources/plugin/mpi;;${{ github.workspace }}/FreeFem-sources/plugin/seq" >> $GITHUB_ENV

      - name: Run ff-bifbox test
        run: |
          mkdir -p test-results
          export workdir=test-results
          export nproc=4
          ln -sf examples/sipp_lebedev_2007/eqns_sipp_lebedev_2007.idp eqns.idp
          ln -sf examples/sipp_lebedev_2007/settings_sipp_lebedev_2007.idp settings.idp
          FreeFem++-mpi -v 0 examples/sipp_lebedev_2007/cylinder.edp -mo $workdir/cylinder
          FreeFem++-mpi -v 0 examples/sipp_lebedev_2007/cavity.edp -mo $workdir/cavity
          ff-mpirun -np $nproc basecompute.edp -v 0 -dir $workdir -mi cylinder.msh -fo cylinder -1/Re 0.1
          ff-mpirun -np $nproc basecompute.edp -v 0 -dir $workdir -mi cavity.msh -fo cavity -1/Re 0.1
          ff-mpirun -np $nproc basecontinue.edp -v 0 -dir $workdir -fi cylinder.base -fo cylinder -param 1/Re -h0 -1 -scount 2 -maxcount 8 -mo cylinder -thetamax 5
          ff-mpirun -np $nproc basecontinue.edp -v 0 -dir $workdir -fi cavity.base -fo cavity -param 1/Re -h0 -1 -scount 4 -maxcount 16 -mo cavity
          ff-mpirun -np $nproc basecompute.edp -v 0 -dir $workdir -fi cylinder_8.base -fo cylinder50 -1/Re 0.021
          ff-mpirun -np $nproc basecompute.edp -v 0 -dir $workdir -fi cavity_16.base -fo cavity4000 -1/Re 0.00025
          ff-mpirun -np $nproc modecompute.edp -v 0 -dir $workdir -fi cylinder50.base -fo cylinder50 -eps_target 0.1+0.8i -sym 1 -eps_pos_gen_non_hermitian
          ff-mpirun -np $nproc modecompute.edp -v 0 -dir $workdir -fi cavity4000.base -fo cavity4000 -eps_target 0.1+8.0i -sym 0 -eps_pos_gen_non_hermitian
          ff-mpirun -np $nproc hopfcompute.edp -v 0 -dir $workdir -fi cylinder50.mode -fo cylinder -param 1/Re -nf 0
          ff-mpirun -np $nproc hopfcompute.edp -v 0 -dir $workdir -fi cavity4000.mode -fo cavity -param 1/Re -nf 0

      - name: Upload test artifacts (logs)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs
          path: test-results/**/*
